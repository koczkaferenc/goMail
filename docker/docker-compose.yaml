services:

  # Autoconfig, proxy
  autoconfigurator:
    image: nginx:alpine
    container_name: ${CONTAINER_NAME}-autoconfig
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./data/tmp/${CONTAINER_NAME}-autoconfig:/tmp
      - ./autoconfigurator/nginx.conf.template:/etc/nginx/templates/default.conf.template
      - ./data/etc/letsencrypt:/etc/letsencrypt:ro
    environment:
      - MAILDOMAIN=${MAILDOMAIN}
      - MAIL_HOST=${MAIL_HOST}
      - WEBMAIL_HOST=${WEBMAIL_HOST}
      - MAILADMIN_HOST=${MAILADMIN_HOST}
      - AUTOCONFIG_HOST=${AUTOCONFIG_HOST}
      - AUTODISCOVER_HOST=${AUTODISCOVER_HOST}
    restart: always
    depends_on:
      - wm
      - ma
    networks:
      - gomail-network         

  dovecot:
    build: ./dovecot
    container_name: ${CONTAINER_NAME}-dovecot
    ports:
      - "143:143"
      - "993:993"
      - "110:110"
      - "995:995"
    environment:
      - MAILDOMAIN=${MAILDOMAIN}
      - MAIL_HOST=${MAIL_HOST}     
      - DOVECOT_MASTERPASSWORD=${DOVECOT_MASTERPASSWORD} 
    volumes:
      - ./data/tmp/${CONTAINER_NAME}-dovecot:/tmp
      - ./data/gomail.db:/etc/dovecot/gomail.db:ro
      - ./data/var/mail:/var/mail
      - ./data/etc/letsencrypt:/etc/letsencrypt:ro
      - ./data/var/log/dovecot:/var/log/dovecot
      # LMTP socket megoszt√°sa
      - ./data/run/dovecot:/var/run/dovecot
    restart: always
    networks:
      - gomail-network       

  imapsync:
    profiles: 
      - imapsync
    image: gilleslamiral/imapsync:latest
    container_name: ${CONTAINER_NAME}-imapsync
    volumes:
      - ./data/tmp/${CONTAINER_NAME}-imapsync:/tmp
      - ./data/etc/imapsync/imapsync-mboxes.csv:/config/imapsync-mboxes.csv:ro
      - ./imapsync/sync_mails.sh:/usr/local/bin/sync_mails.sh:ro
      - ./data/var/log/imapsync:/var/log/imapsync
    environment:
      - DELAY_BETWEEN_SYNCS=${DELAY_BETWEEN_SYNCS}
    entrypoint: ["/bin/bash", "/usr/local/bin/sync_mails.sh"]
    networks:
      - gomail-network    

  # Roundcube webmail 
  wm:
    image: roundcube/roundcubemail:latest
    container_name: ${CONTAINER_NAME}-webmail
    restart: always
    environment:
      - ROUNDCUBEMAIL_DEFAULT_HOST=dovecot
      - ROUNDCUBEMAIL_DEFAULT_PORT=143
      - ROUNDCUBEMAIL_SMTP_SERVER=disabled
      - ROUNDCUBEMAIL_SKIN=elastic
    volumes:
      - ./data/tmp/${CONTAINER_NAME}-wm:/tmp
      - ./data/var/roundcube:/var/roundcube/db
    networks:
      - gomail-network         
  
  # Webadmin 
  ma:
    image: nginx:alpine
    container_name: ${CONTAINER_NAME}-webadmin
    restart: always
    volumes:
      - ./data/tmp/${CONTAINER_NAME}-ma:/tmp
      - ./webroot-ma:/usr/share/nginx/html:ro
    networks:
      - gomail-network   

networks:
  gomail-network:
    driver: bridge
     
# volumes:
#   dovecot_sockets:
